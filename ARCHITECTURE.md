# Архитектура системы

## Обзор

Система построена на трёхуровневой модели с разделением ответственности между компонентами. Основной принцип — полная маскировка VPN-трафика под легитимный HTTPS.

## Типы нод

### Entry-ноды

| Характеристика | Описание |
|----------------|----------|
| Функция | Приём клиентских подключений, маскировка под веб-сайт |
| Расположение | За пределами региона с ограничениями (или внутри — этап 3) |
| Жизненный цикл | Недолгоживущие, легко заменяемые |
| Количество | Много (при масштабировании) |
| Знание топологии | Не более 30% Core-нод |
| Связность | Не связываются между собой, только с Core-нодами |

### Core-ноды

| Характеристика | Описание |
|----------------|----------|
| Функция | Маршрутизация трафика в интернет, PKI, управление |
| Расположение | Защищённые, долгоживущие серверы |
| Жизненный цикл | Долгоживущие |
| Количество | Относительно небольшое |
| Связность | Полная связность между собой |
| Доверие | Проверяют друг друга через общий Root CA |

## Топология сети

```
┌─────────────────────────────────────────────────────────────────┐
│                         ИНТЕРНЕТ                                 │
│              (DPI, активное зондирование)                        │
└───────────────────────────┬─────────────────────────────────────┘
                            │
                            │ TLS 1.3 (порт 443)
                            │ Неотличим от обычного HTTPS
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                     NGINX (публичный)                           │
│                                                                  │
│  Слушает: 0.0.0.0:443                                           │
│  TLS-терминация + маршрутизация по URL path                     │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │  /                        → Сайт-прикрытие (статика)    │    │
│  │  /api/v2/xhttp/{random}/  → Xray XHTTP  (127.0.0.1)     │    │
│  │  /api/v2/stream/{random}/ → Xray WS     (127.0.0.1)     │    │
│  │  /api/v2/rpc/{random}/    → Xray gRPC   (127.0.0.1)     │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  Fallback: любой неверный запрос → сайт-прикрытие (200 OK)      │
└──────────────────┬──────────────────────────────────────────────┘
                   │
                   │ localhost
                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                     XRAY-CORE                                    │
│                                                                  │
│  Inbound #1: VLESS + XHTTP      (127.0.0.1:10001)               │
│  Inbound #2: VLESS + WebSocket  (127.0.0.1:10002)               │
│  Inbound #3: VLESS + gRPC       (127.0.0.1:10003)               │
│                                                                  │
│  Outbound: freedom → интернет (этап 1)                          │
│            → Core-нода (этап 2+)                                │
└─────────────────────────────────────────────────────────────────┘
```

## Принцип маскировки

### Что видит внешний наблюдатель

| Наблюдение | Реальность |
|------------|------------|
| HTTPS к mimimi.pro | VPN-туннель |
| TLS 1.3 handshake | Стандартный, неотличимый |
| Валидный сертификат Let's Encrypt | Да |
| WebSocket соединение | VLESS через WS |
| gRPC вызовы (HTTP/2) | VLESS через gRPC |
| GET/POST запросы | Сайт-прикрытие |

### Защита от активного зондирования

При обращении на секретные пути без правильных VLESS-заголовков:

- Сервер отдаёт сайт-прикрытие (200 OK)
- Наблюдатель не может отличить «секретный путь» от «обычной страницы»
- Нет характерных ошибок или редиректов

## Протоколы и транспорты

### Клиент ↔ Entry-нода

| Параметр | Значение |
|----------|----------|
| Протокол | VLESS |
| Шифрование | TLS 1.3 |
| Транспорты | XHTTP (основной), WebSocket, gRPC |
| Маскировка | Под легитимный HTTPS-сайт |

**Приоритет транспортов:**

1. **XHTTP (splithttp)** — разбивает соединение на короткие HTTP-запросы, эффективен против active probing
2. **WebSocket** — совместим с CDN, похож на чаты и уведомления
3. **gRPC** — HTTP/2, мультиплексирование, похож на микросервисы

### Entry-нода ↔ Core-нода

| Параметр | Значение |
|----------|----------|
| Транспорт | TLS-туннель |
| Требования | Простота и надёжность |
| Маскировка | Не требуется (внутренняя сеть) |

## Инфраструктура открытых ключей (PKI)

### Иерархия сертификатов

```
Root CA (долгосрочный, критический)
    │
    ├── Core-нода #1 (промежуточный CA)
    │       │
    │       ├── Entry-нода A
    │       └── Entry-нода B
    │
    └── Core-нода #2 (промежуточный CA)
            │
            └── Entry-нода C
```

### Правила

- Root CA выпускает сертификаты только для Core-нод
- Core-нода может выпускать сертификаты для Entry-нод
- Entry-нода принимает сертификаты любой Core-ноды
- Core-ноды проверяют друг друга через общий Root CA

### Жизненный цикл сертификатов

| Тип | Срок жизни | Отзыв |
|-----|------------|-------|
| Root CA | Долгосрочный | Ручной, критический инцидент |
| Core-нода | Долгосрочный | Ручной |
| Entry-нода (этап 1) | Долгоживущий | Ручной |
| Entry-нода (этап 2+) | Часы/дни | Автоматический |

## Принцип минимальной связности

Entry-нода знает только часть топологии:

- Не более 30% Core-нод
- Не знает о других Entry-нодах

### Каскадный отзыв при компрометации

При компрометации Entry-ноды A, которая знала Entry-ноды B, C и Core-ноды X, Y:

1. Вывести из оборота: A, B, C
2. Вывести Core-ноды X, Y (если общее количество Core > 2)
3. Перевыпустить сертификаты для всех затронутых Entry-нод

## Варианты размещения Entry-нод

### Вариант A: За пределами региона

```
Клиент (внутри региона)
    │
    │ HTTPS (через границу)
    ▼
Entry-нода (Япония/Сингапур)
    │
    ▼
Core-нода → Интернет
```

**Плюсы:** Высокая физическая безопасность
**Минусы:** Трафик клиента пересекает границу (больше внимания DPI)

### Вариант B: Внутри региона

```
Клиент (внутри региона)
    │
    │ HTTPS (внутренний)
    ▼
Entry-нода (ЦОД внутри региона)
    │
    │ TLS (через границу)
    ▼
Core-нода (за пределами) → Интернет
```

**Плюсы:**
- Клиентский трафик остаётся внутри региона (менее подозрителен)
- Серверный трафик из ЦОД менее заметен
- Низкая латентность для клиента

**Минусы:**
- Физический доступ к серверу возможен
- Entry-нода должна быть расходной

### Рекомендация: Гибридный подход

Комбинация Entry-нод внутри и снаружи региона для баланса скорости и надёжности.

## Сайт-прикрытие

Каждая Entry-нода размещает полноценный веб-сайт:

| Параметр | Значение |
|----------|----------|
| Тип | SPA (Single Page Application) |
| Размер | >16 КБ (обход частичной загрузки) |
| Контент | NFT-галерея с виртуальными персонажами |
| Язык | Русский |
| CSS/JS | Встроенные в HTML |

Сайт должен выглядеть легитимным при ручной проверке.

## Этапы развития

### Этап 1 — MVP

| Параметр | Значение |
|----------|----------|
| Core-ноды | 0 (Xray → freedom) |
| Entry-ноды | 1 |
| Транспорты | XHTTP, WebSocket, gRPC |
| Деплой | Ручной |
| Контейнеризация | Нет |

### Этап 2 — Core-нода

| Параметр | Значение |
|----------|----------|
| Core-ноды | 1 |
| Entry-ноды | 1 |
| Связка | Entry → Core → Интернет |

### Этап 3 — Entry внутри региона

| Параметр | Значение |
|----------|----------|
| Entry-ноды | 2+ (внутри и снаружи региона) |
| Гибридная модель | Да |

### Этап 4 — Автоматизация

| Параметр | Значение |
|----------|----------|
| Контейнеризация | Docker |
| IaC | Terraform/Ansible |
| CI/CD | Автоматический деплой |
| Мониторинг | Health-checks, алерты |

## Отказоустойчивость

### Минимальная конфигурация

Сеть работоспособна при наличии:
- Минимум 1 Core-ноды
- Минимум 1 Entry-ноды

### Уровень автоматизации по этапам

| Этап | Реагирование на инциденты |
|------|---------------------------|
| 1 | Ручное |
| 2 | Полуавтоматическое (мониторинг + ручной запуск) |
| 3+ | Автоматический каскадный отзыв |

## Глоссарий

| Термин | Определение |
|--------|-------------|
| Entry-нода | Узел первой линии, принимает клиентские подключения |
| Core-нода | Узел ядра сети, маршрутизирует трафик в интернет |
| VLESS | Легковесный протокол V2Ray без встроенного шифрования |
| XHTTP | Транспорт splithttp, разбивает соединение на короткие HTTP-запросы |
| Active probing | Техника DPI: активное подключение к серверу для проверки протокола |
| Fallback | Резервный механизм при отказе основного |
| PKI | Public Key Infrastructure — инфраструктура открытых ключей |
| DPI | Deep Packet Inspection — глубокий анализ пакетов |

---

*Документ обновляется по мере развития проекта.*
