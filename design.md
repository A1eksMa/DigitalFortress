# Архитектура системы обхода цензуры

**Версия:** 1.0
**Дата:** 2025-12-09
**Время:** UTC

---

## 1. Введение

Данный документ описывает архитектуру частной сети, предназначенной для обхода региональных ограничений. Система проектируется с учётом устойчивости к обнаружению и детекции современными системами DPI (Deep Packet Inspection) и активного зондирования (active probing).

Архитектура разработана для частного использования ограниченным кругом лиц, но предусматривает возможность горизонтального масштабирования для коммерческой эксплуатации.

---

## 2. Цель

Создание децентрализованной сети, которая:

- Сохраняет работоспособность при наличии минимум двух нод (разных типов)
- Устойчива к блокировкам и компрометации отдельных узлов
- Маскирует трафик под легитимную интернет-активность
- Поддерживает механизмы ротации и автоматического восстановления
- Масштабируется от личного использования до коммерческой эксплуатации

---

## 3. Архитектура сети

### 3.1. Типы нод

Сеть состоит из двух основных типов узлов:

#### Entry-ноды (первый тип)

- **Функция:** Принимают соединения от клиентов и передают их внутрь сети
- **Расположение:** В "белом списке" — доступны из любой точки, не подвержены региональным блокировкам
- **Жизненный цикл:** Недолгоживущие, легко заменяемые
- **Количество:** Много (на этапе масштабирования)
- **Ротация:** Постоянная, по расписанию и при компрометации
- **Знание топологии:** Не более 30% от всех Core-нод
- **Связность:** Entry-ноды НЕ связываются между собой, только с Core-нодами

#### Core-ноды (второй тип)

- **Функция:** Принимают соединения от Entry-нод, маршрутизируют трафик во внешний интернет
- **Расположение:** Могут находиться в заблокированном сегменте (доступ через Entry-ноды)
- **Жизненный цикл:** Долгоживущие, сложные в настройке
- **Количество:** Относительно небольшое
- **Связность:** Образуют тесную сеть, могут перенаправлять и балансировать трафик между собой
- **Доверие:** Доверяют друг другу, проверяют принадлежность к общему центру авторизации

### 3.2. Топология

```
[Клиент]
    ↓ (VLESS/XHTTP, маскировка под HTTPS)
[Entry-нода] ← сайт-прикрытие, SSL-сертификат, домен
    ↓ (TLS-туннель)
[Core-нода] ← инфраструктура, PKI, списки нод
    ↓
[Внешний интернет]
```

### 3.3. Принцип минимальной связности

- Entry-нода знает только часть Core-нод (≤30%)
- Entry-ноды не знают друг о друге напрямую
- Списки Entry-нод хранятся на Core-нодах
- При компрометации Entry-ноды выводится из оборота:
  - Сама скомпрометированная нода
  - Все Entry-ноды, о которых она знала
  - Все Core-ноды, о которых она знала (при количестве Core-нод > 2)

---

## 4. Инфраструктура открытых ключей (PKI)

### 4.1. Иерархия сертификатов

```
[Root CA] — корневой центр авторизации
    ↓
[Core-ноды] — промежуточные CA, могут выпускать сертификаты для Entry-нод
    ↓
[Entry-ноды] — конечные сертификаты
```

### 4.2. Правила выпуска сертификатов

- Root CA выпускает сертификаты только для Core-нод
- Любая Core-нода может выпускать сертификаты для Entry-нод
- Entry-нода принимает сертификаты, выпущенные любой Core-нодой сети
- Core-ноды проверяют друг друга на принадлежность к общему Root CA

### 4.3. Стратегия жизненного цикла сертификатов

| Тип сертификата | Срок жизни | Механизм отзыва |
|-----------------|------------|-----------------|
| Root CA | Долгосрочный | Ручной, критический инцидент |
| Core-нода | Долгосрочный | Ручной отзыв |
| Entry-нода (этап 1) | Долгоживущий | Ручной отзыв |
| Entry-нода (этап 2+) | Короткоживущий (часы/дни) | Автоматический, не продлевается |

### 4.4. Каскадный отзыв (сценарий компрометации)

При компрометации Entry-ноды, которая знала полный список всех Entry-нод:
1. Полный отказ от всех связанных Entry-нод
2. Перевыпуск всего пула Entry-нод
3. Аналогия: "дерево, которое сбрасывает листья"

---

## 5. Механизм обнаружения нод (Discovery)

### 5.1. Получение списка нод

- При деплое Entry-нода получает список всех Entry-нод (включая себя)
- Список хранится на Core-нодах или в приватном репозитории
- Entry-ноды периодически синхронизируют список с Core-нодами

### 5.2. Поведение клиента

1. Получает IP-адрес одной из Entry-нод (bootstrap)
2. Подключается к Entry-ноде, получает актуальный список
3. Пингует все ноды из списка
4. Отбрасывает неотвечающие
5. Подключается к ноде с наименьшим пингом
6. Периодически меняет ноды между сеансами
7. Узнаёт о новых нодах от текущей Entry-ноды

### 5.3. Bootstrap-механизмы

#### Личное использование (до 3 нод):
- IP-адрес от администратора напрямую

#### Коммерческое использование:
- Сайт с регистрацией и личным кабинетом
- Каналы в социальных сетях
- Email-рассылка с init-настройками
- DNS TXT-запись к домену за CDN
- Telegram-бот

### 5.4. Гарантии актуальности списка

При большом количестве нод:
- Ротация выстроена так, что ноды не меняются все одновременно
- Всегда часть нод остаётся, часть меняется
- Минимум 2/3 нод из списка актуальны в любой момент

### 5.5. Возврат офлайн-клиента

Если клиент долго был офлайн и все известные ему Entry-ноды ротировались:
- Fallback на bootstrap-каналы (Telegram-бот, email, DNS, соцсети)
- В личном использовании — прямой контакт с администратором

---

## 6. Протоколы и транспорты

### 6.1. Клиент ↔ Entry-нода (внешний уровень)

**Требование:** Трафик должен быть неотличим от обычного HTTPS-трафика.

| Параметр | Значение |
|----------|----------|
| Протокол | VLESS (возможна кастомная модификация на поздних этапах) |
| Транспорт (этап 1) | XHTTP (splithttp) — основной и единственный |
| Транспорт (этап 2+) | XHTTP → WebSocket → gRPC (fallback-цепочка) |
| Шифрование | TLS 1.3 с валидным SSL-сертификатом |
| Маскировка | Под легитимный HTTPS-сайт с доменом |

**Приоритет:** Надёжность важнее latency.

**Обоснование выбора XHTTP:**
- Разбивает соединение на множество коротких HTTP-запросов
- Эффективен против active probing
- Сложнее детектировать статистическими методами

### 6.2. Entry-нода ↔ Core-нода (внутренний уровень)

| Параметр | Значение |
|----------|----------|
| Транспорт | Обычный TLS-туннель |
| Требования | Простота и надёжность |

Внутри сети маскировка не требуется — достаточно шифрования и аутентификации.

---

## 7. Сайт-прикрытие

### 7.1. Концепция

Каждая Entry-нода размещает полноценный сайт — NFT-галерею с кошкодевочками:
- Рисованные от руки персонажи из разных стран
- Разные тарифы, личное использование
- NFT как токенизация услуг VPN-сервиса (валюта системы)

### 7.2. Техническая реализация

| Компонент | Описание |
|-----------|----------|
| Контент | Статический сайт, билдится из MD-файлов |
| Обновление | Периодический ребилд с актуализацией контента |
| Форма регистрации | Присутствует для видимости (без функционала до этапа 3) |
| Контент за регистрацией | Текстовый, аудио, видео (заявлено) |
| Открытый контент | Небольшое количество статики без регистрации |

### 7.3. Разнообразие

- Сайты на разных Entry-нодах разные, но однотипные
- По сути — зеркала с разными по времени билдами
- Контент немного меняется во времени для "живости"

---

## 8. Личный кабинет и биллинг

### 8.1. Архитектура

- **Тип инфраструктуры:** Третий тип, полностью отделён от VPN-сети
- **Появление:** Только на этапе 3 (коммерческая эксплуатация)
- **До этапа 3:** Форма регистрации — декорация без реального функционала

### 8.2. Обоснование разделения

- Компрометация Entry-ноды не даёт доступа к данным пользователей
- Личный кабинет защищён независимо от VPN-инфраструктуры
- Отдельная точка защиты и мониторинга

---

## 9. Этапы развития

### Этап 1 — MVP для личного использования

| Параметр | Значение |
|----------|----------|
| Core-ноды | 1 |
| Entry-ноды | 1 |
| Сертификаты Entry | Долгоживущие |
| Деплой | Ручной |
| Мониторинг | Ручной (посещение ноды, системные параметры) |
| Bootstrap | Прямой контакт с администратором |
| Ротация и отзыв | Вручную |
| Транспорт | Только XHTTP |

### Этап 2 — Масштабирование

| Параметр | Значение |
|----------|----------|
| Core-ноды | 2+ |
| Entry-ноды | 3+ |
| Сертификаты Entry | Короткоживущие (часы/дни) |
| Деплой | Автоматизация (Terraform/Ansible + API провайдеров) |
| Мониторинг | Системы мониторинга и health-check |
| Сертификаты | Автоматический перевыпуск |
| Ротация | Автоматическая по расписанию |
| Транспорт | XHTTP → WebSocket → gRPC (fallback) |
| Хостинг | Облачные сервисы с поддержкой масштабирования |
| Продвижение | Соцсети, прямые каналы, личные знакомства |
| Статус | Бета-тестирование |

### Этап 3 — Коммерческая эксплуатация

| Параметр | Значение |
|----------|----------|
| Личный кабинет | Полноценный микросервис (отдельная инфраструктура) |
| Биллинг | Интеграция с NFT-токенами |
| Поддержка | Формализованная, SLA |
| Реагирование | Автоматическое на компрометацию (каскадный отзыв) |
| Балансировка | Автоматическая между Core-нодами |
| География | Распределённая инфраструктура |

---

## 10. Отказоустойчивость

### 10.1. Минимальная конфигурация

Сеть работоспособна при наличии:
- Минимум 1 Core-ноды
- Минимум 1 Entry-ноды

### 10.2. Реакция на компрометацию Entry-ноды

1. Вывод из оборота скомпрометированной ноды
2. Вывод всех Entry-нод, о которых она знала
3. Вывод Core-нод, о которых она знала (до 30%, при количестве Core > 2)
4. Перевыпуск затронутого пула Entry-нод

### 10.3. Уровень автоматизации по этапам

| Этап | Реагирование |
|------|--------------|
| 1 | Ручное (алерты администратору) |
| 2 | Полуавтоматическое (мониторинг + ручной запуск) |
| 3 | Автоматическое (каскадный отзыв) |

---

## 11. Вопросы для дальнейшего обсуждения

### Инфраструктура и деплой

1. Какие облачные провайдеры предпочтительны для Entry-нод? (критерии: цена, API, отсутствие блокировок)
2. Формат хранения конфигураций и секретов (Vault, SOPS, sealed secrets?)
3. Структура приватного репозитория для списков нод и конфигураций
4. Инструменты IaC: Terraform, Pulumi, или другое?

### PKI и безопасность

5. Где физически хранится Root CA? (air-gapped, HSM, или достаточно зашифрованного хранилища?)
6. Формат и протокол распространения CRL/статуса сертификатов между Core-нодами
7. Механизм верификации списка нод клиентом (подпись Core-ноды?)
8. Ротация ключей Core-нод — периодичность и процедура

### Протоколы и клиенты

9. Какие клиентские приложения будут поддерживаться? (кастомный клиент, или совместимость с v2rayN/NekoBox/etc?)
10. Кастомизация VLESS на поздних этапах — какие именно паттерны нужно менять?
11. Механизм автоматического fallback транспортов на клиенте

### Мониторинг

12. Какие метрики критичны для health-check Entry-нод?
13. Как детектировать компрометацию ноды (vs просто недоступность)?
14. Система алертов: Telegram, email, PagerDuty?

### Сайт-прикрытие

15. Источник контента для NFT-галереи (художник, генерация, микс?)
16. Частота обновления статического контента
17. Домены: регистратор, стратегия именования, количество на этап

### Коммерция (этап 3)

18. Механика NFT-токенов как валюты (блокчейн, смарт-контракты?)
19. Интеграция биллинга с VPN-доступом
20. Юридическая структура для приёма платежей

---

## Приложение A: Глоссарий

| Термин | Определение |
|--------|-------------|
| Entry-нода | Узел первой линии, принимает клиентские подключения |
| Core-нода | Узел ядра сети, маршрутизирует трафик в интернет |
| XHTTP | Транспорт splithttp в Xray-core, разбивает соединение на короткие HTTP-запросы |
| Active probing | Техника DPI: активное подключение к серверу для проверки протокола |
| Bootstrap | Процесс первоначального получения адреса Entry-ноды клиентом |
| Fallback | Резервный механизм при отказе основного |
| PKI | Public Key Infrastructure — инфраструктура открытых ключей |

---

*Документ подготовлен по результатам архитектурного обсуждения. Подлежит обновлению по мере проработки открытых вопросов.*
