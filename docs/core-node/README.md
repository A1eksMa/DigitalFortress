# Core-нода

> **Статус:** Этап 2 (в разработке)

Core-нода — скрытый узел ядра сети, который принимает трафик от Entry-нод и маршрутизирует его в открытый интернет.

---

## Роль в архитектуре

```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   Клиент    │ ───▶ │ Entry-нода  │ ───▶ │ Core-нода   │ ───▶ Интернет
│   (РФ)      │      │   (РФ)      │      │  (Япония)   │
└─────────────┘      └─────────────┘      └─────────────┘
                                          ^^^^^^^^^^^^^
                                          Этот документ
```

---

## Архитектурные решения (Этап 2)

### Общая концепция

Трафик между Entry-нодой и Core-нодой маскируется под обычное HTTPS-соединение к веб-серверу. Это позволяет обходить DPI, который анализирует трафик на границе.

### Выбранная схема

| Параметр | Решение | Обоснование |
|----------|---------|-------------|
| Транспорт Entry → Core | WebSocket | Проверен на Entry-ноде, работает через DPI |
| TLS | Самоподписанный сертификат | Минимальная сложность, не требует домена |
| Верификация TLS | `allowInsecure: true` | Упрощает настройку; при необходимости — certificate pinning |
| Сайт-прикрытие | NFT-галерея | Защита от активного зондирования |
| Формат путей | `/api/v2/stream/{random}/` | Единообразие с Entry-нодой |

### Почему не требуется домен для Core-ноды

1. **Клиенты не подключаются к Core напрямую** — им не нужен запоминаемый адрес
2. **Entry-нода знает IP Core-ноды** — домен не даёт преимуществ
3. **Самоподписанный сертификат достаточен** — Entry-нода доверяет ему явно
4. **Серверный трафик к IP — обычная практика** — микросервисы, API, бэкенды

При блокировке этой схемы можно добавить домен и Let's Encrypt.

---

## Полная схема взаимодействия

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            КЛИЕНТ (РФ)                                  │
│                        v2rayNG / NekoRay                                │
│                                                                         │
│  Подключение: vless://...@mimimi.pro:443?type=grpc&security=tls        │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
                                 │ VLESS + gRPC/WS + TLS 1.3
                                 │ Сертификат: Let's Encrypt
                                 │ SNI: mimimi.pro
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    ENTRY-НОДА (94.232.46.43, РФ)                        │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ Nginx (0.0.0.0:443)                                               │  │
│  │                                                                   │  │
│  │   TLS терминация (Let's Encrypt)                                  │  │
│  │   ├── /api/v2/stream/{path}/ ──▶ Xray:10002 (клиенты, WS)        │  │
│  │   ├── /api.v2.rpc.{path}     ──▶ Xray:10003 (клиенты, gRPC)      │  │
│  │   └── /                      ──▶ Сайт-прикрытие                  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                 │                                       │
│                                 ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ Xray-core (127.0.0.1)                                             │  │
│  │                                                                   │  │
│  │   Inbound :10002 (VLESS + WS)   ─┐                                │  │
│  │   Inbound :10003 (VLESS + gRPC) ─┼──▶ Outbound: to-core          │  │
│  │                                                                   │  │
│  │   Outbound "to-core":                                             │  │
│  │     protocol: vless                                               │  │
│  │     address: 45.63.121.41:443                                     │  │
│  │     transport: WebSocket                                          │  │
│  │     security: TLS (allowInsecure)                                 │  │
│  │     path: /api/v2/stream/{core-path}/                             │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
                                 │ WebSocket over TLS
                                 │ Самоподписанный сертификат
                                 │ Порт 443
                                 │
                                 │ ┌─────────────────────────────────┐
                                 │ │ Что видит DPI:                  │
                                 │ │                                 │
                                 │ │ • TLS 1.2/1.3 к IP в Японии    │
                                 │ │ • Порт 443 (стандартный HTTPS) │
                                 │ │ • Похоже на API/микросервис    │
                                 │ │ • Серверный трафик — норма     │
                                 │ └─────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    CORE-НОДА (45.63.121.41, Япония)                     │
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ Nginx (0.0.0.0:443)                                               │  │
│  │                                                                   │  │
│  │   TLS терминация (самоподписанный сертификат)                     │  │
│  │   ├── /api/v2/stream/{core-path}/ ──▶ Xray:10001 (от Entry, WS)  │  │
│  │   └── /                           ──▶ Сайт-прикрытие             │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                 │                                       │
│                                 ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ Xray-core (127.0.0.1)                                             │  │
│  │                                                                   │  │
│  │   Inbound :10001 (VLESS + WS, от Entry-ноды)                      │  │
│  │         │                                                         │  │
│  │         ▼                                                         │  │
│  │   Outbound: freedom ──▶ Интернет                                  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────┬────────────────────────────────────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │    ИНТЕРНЕТ     │
                        │                 │
                        │  Любые сайты    │
                        │  и сервисы      │
                        └─────────────────┘
```

---

## Защита от активного зондирования

При попытке проверить Core-ноду:

```
┌─────────────────────────────────────────────────────────────────────────┐
│  Проверяющий: curl https://45.63.121.41/                               │
│                                                                         │
│  1. TLS handshake                                                       │
│     └── Успешно (самоподписанный сертификат)                           │
│                                                                         │
│  2. HTTP GET /                                                          │
│     └── Nginx отдаёт сайт-прикрытие (NFT-галерея)                       │
│                                                                         │
│  3. Результат: "Обычный веб-сервер с галереей изображений"             │
│                                                                         │
│  Проверяющий: curl https://45.63.121.41/api/v2/stream/random/          │
│                                                                         │
│  1. Путь не совпадает с секретным                                       │
│     └── Nginx: location / (fallback)                                   │
│     └── Отдаёт сайт-прикрытие                                          │
│                                                                         │
│  2. Результат: "Тот же веб-сайт, ничего подозрительного"               │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Параметры туннеля Entry → Core

| Параметр | Значение |
|----------|----------|
| Протокол | VLESS |
| Транспорт | WebSocket |
| Адрес | 45.63.121.41 |
| Порт | 443 |
| TLS | Да (самоподписанный) |
| Путь | `/api/v2/stream/{случайный}/` |
| UUID | `d2e5507d-e265-44ba-acc4-1356e4a6d70e` |

---

## Характеристики Core-ноды

| Параметр | Значение |
|----------|----------|
| Функция | Маршрутизация трафика от Entry-нод в интернет |
| Жизненный цикл | Долгоживущая, защищённая |
| Публичный доступ | Только для Entry-нод (не для клиентов) |
| Сайт-прикрытие | Да (защита от зондирования) |
| Домен | Не требуется (опционально для будущих этапов) |

---

## Задачи Core-ноды

1. Приём трафика от Entry-нод через WebSocket
2. Маршрутизация во внешний интернет
3. Отдача сайта-прикрытия при некорректных запросах

### Будущие задачи (этап 3+)

4. Управление PKI (выпуск сертификатов для Entry-нод)
5. Хранение списков Entry-нод
6. Мониторинг и health-check Entry-нод

---

## Эволюция схемы

### Текущая (этап 2)

```
Entry (РФ) ──WebSocket+TLS──▶ Core (Япония) ──▶ Интернет
              самоподписанный
              allowInsecure
```

### При блокировке (этап 2.1)

```
Entry (РФ) ──WebSocket+TLS──▶ Core (Япония) ──▶ Интернет
              Let's Encrypt
              домен core.example.com
```

### При усилении блокировки (этап 2.2)

```
Entry (РФ) ──WebSocket+TLS──▶ CDN (Cloudflare) ──▶ Core ──▶ Интернет
              через CDN
              IP не виден
```

---

## Документация по настройке

| Документ | Описание |
|----------|----------|
| [01-requirements.md](01-requirements.md) | Требования к серверу |
| [02-server-setup.md](02-server-setup.md) | Базовая настройка ОС |
| [03-certificates.md](03-certificates.md) | Генерация самоподписанного сертификата |
| [04-nginx-setup.md](04-nginx-setup.md) | Установка и настройка Nginx |
| [05-xray-install.md](05-xray-install.md) | Установка и настройка Xray |
| [06-entry-node-update.md](06-entry-node-update.md) | Обновление конфига Entry-ноды |

---

*Документ обновлён: 2026-01-20*
